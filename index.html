<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Simple RESTful Web Service to Schedule R Batch Jobs • restbatch</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="A Simple RESTful Web Service to Schedule R Batch Jobs">
<meta property="og:description" content="Starts web services accepting http requests, automatically
    receive, schedule and scale the tasks via the package batchtools as
    the backend. Provides integration to monitor the submitted tasks in 
    RStudio or Shiny apps.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">restbatch</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/introduction.html">1. Introduction</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/dipterix/restbatch/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="a-small-restful-framework-to-run-batch-r-scripts-in-the-background" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#a-small-restful-framework-to-run-batch-r-scripts-in-the-background" class="anchor"></a>A small ‘RESTful’ framework to run batch R scripts in the background</h1></div>
<!-- badges: start -->

<blockquote>
<p>This package is still under development. A road map will be built on Github soon.</p>
</blockquote>
<p>Starts simple ‘<a href="https://restfulapi.net/">RESTful</a>’ R servers running batch jobs anywhere to unleash the computing power:</p>
<ul>
<li>On local machine</li>
<li>Runs within a lab that has idle computers or servers (see <a href="#3-remote-setups">remote setups</a>)</li>
<li>Runs on a public server, see <a href="#5-network-safety">network safety</a> and <a href="#3-remote-setups">remote setups</a> (under construction)</li>
</ul>
<p>The package automatically queues and schedules R tasks that would run hours or days without blocking the main session. It runs even if you exit the main R session. The tasks can be monitored and inspected in multiple ways.</p>
<p>Try <code>restbatch</code> if you need to run R scripts in the background that take minutes, hours, or even days. Don’t use <code>restbatch</code> if the tasks are micro-operations (use <code>clustermq</code> instead).</p>
<div id="1-installation" class="section level2">
<h2 class="hasAnchor">
<a href="#1-installation" class="anchor"></a>1. Installation</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("remotes")</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"dipterix/restbatch"</span><span class="op">)</span></code></pre></div>
<p>The package is to be on CRAN once fully tested</p>
</div>
<div id="2-basic-usage" class="section level2">
<h2 class="hasAnchor">
<a href="#2-basic-usage" class="anchor"></a>2. Basic usage</h2>
<div id="21-start-a-restbatch-server" class="section level3">
<h3 class="hasAnchor">
<a href="#21-start-a-restbatch-server" class="anchor"></a>2.1 Start a <code>restbatch</code> server</h3>
<p>In <code>R</code> or <code>RStudio</code> console</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dipterix/restbatch">restbatch</a></span><span class="op">)</span>

<span class="fu"><a href="reference/default_url.html">default_host</a></span><span class="op">(</span><span class="st">"127.0.0.1"</span><span class="op">)</span>
<span class="fu"><a href="reference/default_url.html">default_port</a></span><span class="op">(</span><span class="fl">7033</span><span class="op">)</span>

<span class="fu"><a href="reference/restbatch-server.html">start_server</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># wait for a second to ramp up the service</span>
<span class="co"># check if the server is alive</span>
<span class="fu"><a href="reference/restbatch-server.html">server_alive</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>A local server will run locally at port <code>7033</code>.</p>
</div>
<div id="22-schedule-a-task" class="section level3">
<h3 class="hasAnchor">
<a href="#22-schedule-a-task" class="anchor"></a>2.2 Schedule a task</h3>
<p>First, let’s create a new task that simply return the process IDs after 2 seconds. The task contains 10 such jobs (<code>x=1:10</code>) and the readable name is <code>Test</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">task</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/restbench-tasks.html">new_task2</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.getpid.html">Sys.getpid</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>, x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, task_name <span class="op">=</span> <span class="st">"Test"</span><span class="op">)</span>

<span class="va">task</span><span class="op">$</span><span class="va">readable_name</span>

<span class="co">#&gt; [1] "Test"</span></code></pre></div>
<p>The task is created locally. However, it will not run until submitted to the restbatch server. To send the task, run</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">task</span><span class="op">$</span><span class="fu">submit</span><span class="op">(</span><span class="op">)</span>

<span class="co">#&gt; Response [http://127.0.0.1:7033/task/new]</span>
<span class="co">#&gt; Date: 2021-02-04 11:04</span>
<span class="co">#&gt; Status: 200</span>
<span class="co">#&gt; Content-Type: application/json</span>
<span class="co">#&gt; Size: 30 B</span></code></pre></div>
<p>If you print the <code>task</code> now, there will be messages as follows:</p>
<pre><code>Task (client proxy from the `restbatch` package)
Task name : [e5f6226c9f2e6874dd3a7f0944b13dcb__Test]
Total jobs: 10
Submitted to: http://127.0.0.1:7033/
Status for 10 jobs at 2021-02-04 05:04:55:
  Submitted    :  0 (  0.0%)
  -- Queued    :  0 (  0.0%)
  -- Started   :  0 (  0.0%)
  ---- Running :  0 (  0.0%)
  ---- Done    :  0 (  0.0%)
  ---- Error   :  0 (  0.0%)
  ---- Expired :  0 (  0.0%)

*Use `task$resolved()` to check whether the task has finished.</code></pre>
<p>Keep down the task name. In this example, the task name is <code>e5f6226c9f2e6874dd3a7f0944b13dcb__Test</code>. Now it’s safe to close your R session.</p>
<p>Open another R session, the task can be restored via</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dipterix/restbatch">restbatch</a></span><span class="op">)</span>
<span class="va">task</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/restbench-tasks.html">restore_task2</a></span><span class="op">(</span><span class="st">"e5f6226c9f2e6874dd3a7f0944b13dcb__Test"</span><span class="op">)</span></code></pre></div>
<p>To obtain the task results, it is always a good practice to check whether a task has been finished or not. This could be achieved via methods <code>resolved</code> or <code>server_status</code> (assuming the server is still running).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">task</span><span class="op">$</span><span class="fu">resolved</span><span class="op">(</span><span class="op">)</span>
<span class="va">task</span><span class="op">$</span><span class="fu">server_status</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>If resolved, or the server status is “finish”, you may now collect results by simply call</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">task</span><span class="op">$</span><span class="fu">collect</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>If not resolved, this step will block your current session until the task is finished or errors occur. The result will be a list of length 10 (length of <code>x</code> variable).</p>
</div>
<div id="23-shutdown-a-server" class="section level3">
<h3 class="hasAnchor">
<a href="#23-shutdown-a-server" class="anchor"></a>2.3 Shutdown a server</h3>
<p>Kill the server right now</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/restbatch-server.html">kill_server</a></span><span class="op">(</span>host <span class="op">=</span> <span class="st">"127.0.0.1"</span>, port <span class="op">=</span> <span class="fl">7033</span><span class="op">)</span></code></pre></div>
<p>All unfinished tasks will be marked as <code>canceled</code> immediately. You need to submit the task again to resume them (see section 2.5 below).</p>
<p>If you have previously set the default <code>host</code> and <code>port</code>, simply call <code><a href="reference/restbatch-server.html">kill_server()</a></code></p>
<p>To kill the server once your current R session is closed,</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/restbatch-server.html">autoclose_server</a></span><span class="op">(</span>host <span class="op">=</span> <span class="st">"127.0.0.1"</span>, port <span class="op">=</span> <span class="fl">7033</span>, auto_close <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div id="24-monitor-tasks" class="section level3">
<h3 class="hasAnchor">
<a href="#24-monitor-tasks" class="anchor"></a>2.4 Monitor task(s)</h3>
<p>An interactive client viewer is available using R <code>shiny</code> package. This viewer can be enabled via</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Install shinydashboard if you haven't done so</span>
<span class="co"># install.packages("shinydashboard")</span>

<span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">'dashboards/client/app.R'</span>, package <span class="op">=</span> <span class="st">'restbatch'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="https://user-images.githubusercontent.com/8163576/106888900-d6dabe80-66ac-11eb-8c1f-27716a3a7112.png" width="50%"></p>
<p>Alternatively, <code>task$monitor()</code> function integrates <code>RStudio</code>, creating job panels in via package <code>rstudioapi</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("rstudioapi")</span>
<span class="va">task</span><span class="op">$</span><span class="fu">monitor</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="25-resume-a-task" class="section level3">
<h3 class="hasAnchor">
<a href="#25-resume-a-task" class="anchor"></a>2.5 Resume a task</h3>
<p>If a server is killed, all unfinished tasks will be canceled. The tasks can be resumed without re-run everything. This requires to submit with flag <code>pack=FALSE</code> and <code>force=TRUE</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">task</span><span class="op">$</span><span class="fu">submit</span><span class="op">(</span>pack<span class="op">=</span><span class="cn">FALSE</span>, force<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="3-remote-setup" class="section level2">
<h2 class="hasAnchor">
<a href="#3-remote-setup" class="anchor"></a>3. Remote setup</h2>
<p>If you have a spare computer or a server, you can set up a <code>restbatch</code> service on that remote computer while submitting the tasks from the local computer.</p>
<p><img src="https://user-images.githubusercontent.com/8163576/107587794-08311e00-6bc8-11eb-8677-d22c04659d49.png" width="90%"></p>
<p>This setup requires that the remote server has a dedicated public IP (your own server) or shares the same intranet as your local computer (like computers in the same lab, or home WiFi).</p>
<p>Deploying a server on the internet may cause security issues. To protect your data, <code>restbatch</code> uses <code>RSA</code> to authorize the connection and requires both remote server and local computer to possess the same private keys. If authentication is enabled, then you’ll need to add a private key to both remote server and local machine.</p>
<div id="31-add-private-keys-to-both-local-machine-and-remote-server" class="section level3">
<h3 class="hasAnchor">
<a href="#31-add-private-keys-to-both-local-machine-and-remote-server" class="anchor"></a>3.1 Add private keys to both local machine and remote server</h3>
<ul>
<li>Step 1: you need to get the user ID on your <strong>local computer</strong>.</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">restbatch</span><span class="fu">::</span><span class="fu"><a href="reference/restbatch-user.html">my_userid</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] "e5f6226c9f2e6874dd3a7f0944b13dcb"</span></code></pre></div>
<ul>
<li>Step 2: on the <strong>remote server</strong>, run the following R command. Remember to replace the <code>userid</code> with your actual ID above. Give your local computer a nice nick name using only letters digits and underscore.</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pem</span> <span class="op">&lt;-</span> <span class="fu">restbatch</span><span class="fu">::</span><span class="fu"><a href="reference/restbatch-user.html">generate_pem</a></span><span class="op">(</span>userid <span class="op">=</span> <span class="st">"e5f6226c9f2e6874dd3a7f0944b13dcb"</span>, 
                               username <span class="op">=</span> <span class="st">"A_nickname"</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span>,
                               pem_file <span class="op">=</span> <span class="st">"~/Downloads/restbatch.pem"</span><span class="op">)</span>
                               
<span class="va">pem</span><span class="op">$</span><span class="va">password</span>
<span class="co">#&gt; [1] "23ae8b0f"</span>

<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">pem</span><span class="op">$</span><span class="va">pem_file</span><span class="op">)</span>
<span class="co">#&gt; ~/Downloads/restbatch.pem</span></code></pre></div>
<ul>
<li>Step 3: Go to your <code>~/Download</code> directory on the <strong>remote server</strong>, where will be a file <code>restbatch.pem</code>. The file looks like the followings if opened with <code>textEdit</code> or <code>notepad</code>.</li>
</ul>
<pre><code>-----BEGIN ENCRYPTED PRIVATE KEY-----
MIIFHDBOBgkqhkiG9w0BBQ0wQTApBgkqhkiG9w0BBQwwHAQIvzx03ePC40ACAggA
... [omitted]
LsPKHCxgtRZbY9iKzGqOeg==
-----END ENCRYPTED PRIVATE KEY-----</code></pre>
<p>Send this file and the password <code>pem$password</code> together to your local computer.</p>
<ul>
<li>Step 4: on your <strong>local computer</strong>, download the <code>restbatch.pem</code>, and run the following R command to add the private key:</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">restbatch</span><span class="fu">::</span><span class="fu"><a href="reference/restbatch-user.html">add_pem</a></span><span class="op">(</span>pem_file <span class="op">=</span> <span class="st">"&lt;path to your 'restbatch.pem'&gt;"</span>, 
                   password <span class="op">=</span> <span class="st">"&lt;the password created by the server&gt;"</span>, 
                   username <span class="op">=</span> <span class="st">"A_nickname"</span><span class="op">)</span></code></pre></div>
<p>Now, the private key is added to your local machine</p>
</div>
<div id="32-connect-to-the-remote-server" class="section level3">
<h3 class="hasAnchor">
<a href="#32-connect-to-the-remote-server" class="anchor"></a>3.2 Connect to the remote server</h3>
<p>To start the service on the <strong>remote server</strong>, run</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">restbatch</span><span class="fu">::</span><span class="fu"><a href="reference/restbatch-server.html">ensure_server</a></span><span class="op">(</span>host<span class="op">=</span><span class="st">"0.0.0.0"</span>, port<span class="op">=</span><span class="fl">7033</span><span class="op">)</span></code></pre></div>
<p>Once the server is on, you can now send tasks from the local computer. By default, tasks will be sent to your local host (“127.0.0.1”). To set your default host as the remote server, you need to get the server IP.</p>
<p>I wrote a tool function that can get your server IP address: (run on your server)</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">restbatch</span><span class="fu">:::</span><span class="fu">get_ip</span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; $available</span>
<span class="co">#&gt; [1] "127.0.0.1"    "0.0.0.0"      "10.0.0.29"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $public</span>
<span class="co">#&gt; [1] "128.100.100.101"</span></code></pre></div>
<blockquote>
<p>If your server is in the intranet, usually the IP is the third one in the first line (in this example, it’s “10.0.0.29”). If your server has a public IP address, then use the second line (in this example, it’s “128.100.100.101”)</p>
</blockquote>
<p>Now, go to your <strong>local computer</strong>, run the following command. Remember to change <code>"10.0.0.29"</code> to your server IP.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dipterix/restbatch">restbatch</a></span><span class="op">)</span>

<span class="co"># set default host to be the remote server</span>
<span class="fu"><a href="reference/default_url.html">default_host</a></span><span class="op">(</span><span class="st">"10.0.0.29"</span><span class="op">)</span>
<span class="fu"><a href="reference/default_url.html">default_port</a></span><span class="op">(</span><span class="fl">7033</span><span class="op">)</span>

<span class="fu">restbatch</span><span class="fu">::</span><span class="fu"><a href="reference/restbatch-server.html">server_alive</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>If the connect is successful, you will see the following result:</p>
<pre><code>[1] TRUE
attr(,"response")
Response [http://10.0.0.29:7033/validate/ping]
  Date: 2021-02-11 00:46
  Status: 200
  Content-Type: application/json
  Size: 2.14 kB</code></pre>
<p>Now everything will be the same.</p>
</div>
</div>
<div id="4-service-configuration" class="section level2">
<h2 class="hasAnchor">
<a href="#4-service-configuration" class="anchor"></a>4 Service configuration</h2>
<p>A <code>restbatch</code> service can be customized via a settings file like follows.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode yml"><code class="sourceCode yaml"><span id="cb22-1"><a href="#cb22-1"></a><span class="fu">host</span><span class="kw">:</span><span class="at"> </span><span class="st">'127.0.0.1'</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">7033</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="fu">protocol</span><span class="kw">:</span><span class="at"> http</span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="fu">server_scripts</span><span class="kw">:</span></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="at">  </span><span class="fu">startup_script</span><span class="kw">:</span><span class="at"> </span><span class="st">'{system.file("scheduler/startup.R", package = "restbatch")}'</span></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="at">  </span><span class="fu">batch_cluster</span><span class="kw">:</span><span class="at"> </span><span class="st">'{system.file("scheduler/cluster.R", package = "restbatch")}'</span></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="fu">modules</span><span class="kw">:</span></span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="at">  </span><span class="fu">task</span><span class="kw">:</span><span class="at"> </span><span class="st">'{system.file("scheduler/task.R", package = "restbatch")}'</span></span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="at">  </span><span class="fu">validate</span><span class="kw">:</span><span class="at"> </span><span class="st">'{system.file("scheduler/validate.R", package = "restbatch")}'</span></span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="at">  </span><span class="fu">info</span><span class="kw">:</span><span class="at"> </span><span class="st">'{system.file("scheduler/info.R", package = "restbatch")}'</span></span>
<span id="cb22-11"><a href="#cb22-11"></a><span class="fu">options</span><span class="kw">:</span></span>
<span id="cb22-12"><a href="#cb22-12"></a><span class="at">  </span><span class="fu">debug</span><span class="kw">:</span><span class="at"> </span><span class="ch">no</span></span>
<span id="cb22-13"><a href="#cb22-13"></a><span class="at">  </span><span class="fu">require_auth</span><span class="kw">:</span><span class="at"> </span><span class="ch">yes</span></span>
<span id="cb22-14"><a href="#cb22-14"></a><span class="at">  </span><span class="fu">anonymous_request</span><span class="kw">:</span><span class="at"> </span><span class="ch">no</span></span>
<span id="cb22-15"><a href="#cb22-15"></a><span class="at">  </span><span class="fu">modules_require_auth</span><span class="kw">:</span><span class="at"> </span><span class="st">'task, validate'</span></span>
<span id="cb22-16"><a href="#cb22-16"></a><span class="at">  </span><span class="fu">max_concurrent_tasks</span><span class="kw">:</span><span class="at"> </span><span class="dv">4</span></span>
<span id="cb22-17"><a href="#cb22-17"></a><span class="at">  </span><span class="fu">max_concurrent_jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb22-18"><a href="#cb22-18"></a><span class="at">  </span><span class="fu">task_queue_interval</span><span class="kw">:</span><span class="at"> </span><span class="fl">0.5</span></span>
<span id="cb22-19"><a href="#cb22-19"></a><span class="at">  </span><span class="fu">max_release_tasks_per_second</span><span class="kw">:</span><span class="at"> </span><span class="dv">100</span></span>
<span id="cb22-20"><a href="#cb22-20"></a><span class="at">  </span><span class="fu">keep_alive</span><span class="kw">:</span><span class="at"> </span><span class="dv">1800</span></span>
<span id="cb22-21"><a href="#cb22-21"></a><span class="at">  </span><span class="fu">task_root</span><span class="kw">:</span><span class="at"> </span><span class="st">'{restbatch::restbatch_getopt("task_root")}'</span></span>
<span id="cb22-22"><a href="#cb22-22"></a><span class="at">  </span><span class="fu">max_nodetime</span><span class="kw">:</span><span class="at"> </span><span class="dv">864000</span></span>
<span id="cb22-23"><a href="#cb22-23"></a><span class="at">  </span><span class="fu">func_newjob</span><span class="kw">:</span><span class="at"> restbatch:::run_task</span></span>
<span id="cb22-24"><a href="#cb22-24"></a><span class="at">  </span><span class="fu">func_validate_server</span><span class="kw">:</span><span class="at"> restbatch::handler_validate_server</span></span></code></pre></div>
<p>To load a settings file, save the above text in a file <code>settings.yaml</code> somewhere, and assign <code>settings</code> when starting the server:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># start_server or ensure_server</span>
<span class="fu">restbatch</span><span class="fu">::</span><span class="fu"><a href="reference/restbatch-server.html">start_server</a></span><span class="op">(</span><span class="va">port</span>, <span class="va">host</span>, settings <span class="op">=</span> <span class="st">"&lt;path to settings.yaml&gt;"</span><span class="op">)</span></code></pre></div>
<p>I’ll explain the main options in this file.</p>
<div id="41-startup-settings" class="section level3">
<h3 class="hasAnchor">
<a href="#41-startup-settings" class="anchor"></a>4.1 Startup settings</h3>
<ul>
<li>
<code>startup_script</code>: the file path to an R script to set up the server before launching services (like connect to databases, or remote nodes etc.). An example (also default script) can be found from <code><a href="https://rdrr.io/r/base/system.file.html">system.file("scheduler/startup.R", package = "restbatch")</a></code> (run this command in R to get its dynamic path)</li>
<li>
<code>batch_cluster</code>: script to schedule each job within a task. By default, each job will spawn a process locally (on the server). It is also possible to use <code>docker</code>, <code>SGE</code>, <code>Slurm</code>, <code>OpenLava</code>, etc. if your server is connected to some computing nodes and provides high-performance parallel services (please check <code><a href="https://rdrr.io/pkg/batchtools/man/makeClusterFunctions.html">?batchtools::makeClusterFunctions</a></code>)</li>
</ul>
</div>
<div id="42-web-modules--authentication" class="section level3">
<h3 class="hasAnchor">
<a href="#42-web-modules--authentication" class="anchor"></a>4.2 Web modules &amp; Authentication</h3>
<p>The <code>modules</code> list contains R <a href="https://www.rplumber.io/">plumber</a> scripts that provide different web entry points. The default entry points are <code>task</code>, <code>validate</code>, and <code>info</code>. Those module files will be mounted with <code><a href="https://www.rplumber.io/reference/pr_mount.html">plumber::pr_mount</a></code>. You can always insert new entry points/modules to the service by including <code>plumber</code> files.</p>
<ul>
<li>
<code>task</code>: a <code>plumber</code> module that receives, schedules, executes, collects, queries, and removes tasks</li>
<li>
<code>validate</code>: a <code>plumber</code> module that provides authentication filters (middle-layers) and some server-level operations (shutdown etc.)</li>
<li>
<code>info</code>: currently serialize task results as <code>JSON</code> formats that can be viewed or downloaded from website</li>
</ul>
<p>Authentication-related settings:</p>
<ul>
<li>
<code>require_auth</code>: whether modules require authentications. It’s highly recommended to be on if deployed remotely, otherwise anyone can run commands on your server.</li>
<li>
<code>anonymous_request</code>: whether to use a fake <code>RSA</code> key. Only set to <code>yes</code> for debug use</li>
<li>
<code>modules_require_auth</code>: which modules require authentication? Use <code>,</code> to separate. Default are <code>task</code> and <code>validate</code> modules.</li>
<li>
<code>keep_alive</code>: once authorized, how long (seconds) will the token be valid until expired? Default is 1800 seconds (30 minutes). Once expired, the token needs to be renewed.</li>
</ul>
</div>
<div id="43-parallel-settings" class="section level3">
<h3 class="hasAnchor">
<a href="#43-parallel-settings" class="anchor"></a>4.3 Parallel settings</h3>
<ul>
<li>
<code>max_concurrent_tasks</code>: how many tasks are allowed to run at the same time</li>
<li>
<code>max_concurrent_jobs</code>: for each task, how many jobs are allowed.</li>
</ul>
<p>A task is created from the function <code>new_task2</code>, and each task may contain multiple jobs. For example, the following task contains 10 jobs (<code>x=1:10</code>, each job corresponds to an element):</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">task</span> <span class="op">&lt;-</span> <span class="fu">restbatch</span><span class="fu">::</span><span class="fu"><a href="reference/restbench-tasks.html">new_task2</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="co"># do something</span>
<span class="op">}</span>, x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>

<span class="va">task</span><span class="op">$</span><span class="va">njobs</span>
<span class="co">#&gt; [1] 10</span></code></pre></div>
</div>
</div>
<div id="5-network-safety" class="section level2">
<h2 class="hasAnchor">
<a href="#5-network-safety" class="anchor"></a>5 Network safety</h2>
<div id="scenario-1-running-as-a-local-service" class="section level3">
<h3 class="hasAnchor">
<a href="#scenario-1-running-as-a-local-service" class="anchor"></a>Scenario 1: Running as a local service</h3>
<p>If the <code>restbatch</code> service is running locally and the host IP is set to <code>127.0.0.1</code>, it is relatively safe. In such case, connections from outside of your machine will not be granted access to the service and you don’t need any authentication. However, if you dispatch the service via anything other than <code>127.0.0.1</code>, then it is possible that someone outside will try to connect to your machine. Therefore it is highly recommended that <code>require_auth</code> is on, <code>anonymous_request</code> is off, and <code>modules_require_auth</code> covers both <code>task</code> and <code>validate</code>.</p>
<p>If you run locally, you don’t need to set up private keys because there will be a key automatically generated for local use.</p>
</div>
<div id="scenario-2-running-in-an-intranet-or-on-a-public-domain-for-personallab-use" class="section level3">
<h3 class="hasAnchor">
<a href="#scenario-2-running-in-an-intranet-or-on-a-public-domain-for-personallab-use" class="anchor"></a>Scenario 2: Running in an intranet or on a public domain for personal/lab use</h3>
<p>Default authentication is required. Don’t share your private keys to anyone that you don’t trust. If your network is hijacked or compromised, use <code>generate_pem</code> with <code>overwrite=TRUE</code> on the server to reset your credentials as soon as possible.</p>
</div>
<div id="scenario-3-public-service-for-arbitrary-users" class="section level3">
<h3 class="hasAnchor">
<a href="#scenario-3-public-service-for-arbitrary-users" class="anchor"></a>Scenario 3: Public service for arbitrary users</h3>
<p>Not recommended to run bare-bone. This is a <code>restbatch</code> task is essentially a collection of R scripts that has the potential to run anything. It’s highly recommended that you wrap the <code>restbatch</code> service into <a href="https://www.docker.com/">docker containers</a> for each user, such that users’ activities are limited to docker container environments.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/dipterix/restbatch/">https://​github.com/​dipterix/​restbatch/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/dipterix/restbatch/issues">https://​github.com/​dipterix/​restbatch/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Zhengjia Wang <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/dipterix/restbench/actions"><img src="https://github.com/dipterix/restbench/workflows/R-CMD-check/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Zhengjia Wang.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
