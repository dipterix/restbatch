<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Server control functions — restbatch-server • restbatch</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Server control functions — restbatch-server" />
<meta property="og:description" content="Start, validate, stop a batch server" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">restbatch</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Server control functions</h1>
    
    <div class="hidden name"><code>restbatch-server.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Start, validate, stop a batch server</p>
    </div>

    <pre class="usage"><span class='fu'>server_alive</span><span class='op'>(</span>
  port <span class='op'>=</span> <span class='fu'><a href='default_url.html'>default_port</a></span><span class='op'>(</span><span class='op'>)</span>,
  host <span class='op'>=</span> <span class='fu'><a href='default_url.html'>default_host</a></span><span class='op'>(</span>allow0 <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>,
  protocol <span class='op'>=</span> <span class='fu'><a href='default_url.html'>default_protocol</a></span><span class='op'>(</span><span class='op'>)</span>,
  path <span class='op'>=</span> <span class='st'>"validate/ping"</span>,
  <span class='va'>...</span>
<span class='op'>)</span>

<span class='fu'>kill_server</span><span class='op'>(</span>
  wait <span class='op'>=</span> <span class='cn'>TRUE</span>,
  host <span class='op'>=</span> <span class='fu'><a href='default_url.html'>default_host</a></span><span class='op'>(</span>allow0 <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>,
  port <span class='op'>=</span> <span class='fu'><a href='default_url.html'>default_port</a></span><span class='op'>(</span><span class='op'>)</span>,
  protocol <span class='op'>=</span> <span class='fu'><a href='default_url.html'>default_protocol</a></span><span class='op'>(</span><span class='op'>)</span>,
  path <span class='op'>=</span> <span class='st'>"validate/shutdown"</span>
<span class='op'>)</span>

<span class='fu'>start_server</span><span class='op'>(</span>
  host <span class='op'>=</span> <span class='fu'><a href='default_url.html'>default_host</a></span><span class='op'>(</span><span class='op'>)</span>,
  port <span class='op'>=</span> <span class='fu'><a href='default_url.html'>default_port</a></span><span class='op'>(</span><span class='op'>)</span>,
  settings <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/system.file.html'>system.file</a></span><span class='op'>(</span><span class='st'>"default_settings.yaml"</span>, package <span class='op'>=</span> <span class='st'>"restbatch"</span><span class='op'>)</span>,
  protocol <span class='op'>=</span> <span class='fu'><a href='default_url.html'>default_protocol</a></span><span class='op'>(</span><span class='op'>)</span>,
  path_validate <span class='op'>=</span> <span class='st'>"validate/ping"</span>,
  make_default <span class='op'>=</span> <span class='cn'>TRUE</span>,
  supervise <span class='op'>=</span> <span class='cn'>FALSE</span>,
  <span class='va'>...</span>
<span class='op'>)</span>

<span class='fu'>autoclose_server</span><span class='op'>(</span>
  host <span class='op'>=</span> <span class='fu'><a href='default_url.html'>default_host</a></span><span class='op'>(</span><span class='op'>)</span>,
  port <span class='op'>=</span> <span class='fu'><a href='default_url.html'>default_port</a></span><span class='op'>(</span><span class='op'>)</span>,
  auto_close <span class='op'>=</span> <span class='cn'>TRUE</span>
<span class='op'>)</span>

<span class='fu'>ensure_server</span><span class='op'>(</span>
  host <span class='op'>=</span> <span class='fu'><a href='default_url.html'>default_host</a></span><span class='op'>(</span><span class='op'>)</span>,
  port <span class='op'>=</span> <span class='fu'><a href='default_url.html'>default_port</a></span><span class='op'>(</span><span class='op'>)</span>,
  protocol <span class='op'>=</span> <span class='fu'><a href='default_url.html'>default_protocol</a></span><span class='op'>(</span><span class='op'>)</span>,
  make_default <span class='op'>=</span> <span class='cn'>TRUE</span>,
  validate <span class='op'>=</span> <span class='cn'>TRUE</span>,
  validate_sleep <span class='op'>=</span> <span class='fl'>0.1</span>,
  validate_maxwait <span class='op'>=</span> <span class='fl'>30</span>,
  timeout <span class='op'>=</span> <span class='fl'>3</span>,
  <span class='va'>...</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>port</th>
      <td><p>integer, which port the server runs at; default see
<code><a href='default_url.html'>default_port</a></code></p></td>
    </tr>
    <tr>
      <th>host</th>
      <td><p>an 'IPv4' address where to run the server on; default see
<code><a href='default_url.html'>default_host</a></code></p></td>
    </tr>
    <tr>
      <th>protocol</th>
      <td><p>'http' or 'https'; default see
<code><a href='default_url.html'>default_protocol</a></code>. 'https' needs extra server settings</p></td>
    </tr>
    <tr>
      <th>path, path_validate</th>
      <td><p>internally used</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>pass to other methods</p></td>
    </tr>
    <tr>
      <th>wait</th>
      <td><p>wait until the server is shut down; default is true.</p></td>
    </tr>
    <tr>
      <th>settings</th>
      <td><p>path to a server configuration file; a sample can be
obtained via <code><a href='conf_sample.html'>conf_sample</a></code>; see details</p></td>
    </tr>
    <tr>
      <th>make_default</th>
      <td><p>whether to make the server default? If so, all tasks
will be sent to this server by default.</p></td>
    </tr>
    <tr>
      <th>supervise</th>
      <td><p>whether to shutdown the server when current R session
expires; default is <code>FALSE</code></p></td>
    </tr>
    <tr>
      <th>auto_close</th>
      <td><p>same as <code>supervise</code></p></td>
    </tr>
    <tr>
      <th>validate</th>
      <td><p>whether to check server is alive once created, default is
<code>TRUE</code>; see details</p></td>
    </tr>
    <tr>
      <th>validate_sleep</th>
      <td><p>if validation is on, intervals to check alive</p></td>
    </tr>
    <tr>
      <th>validate_maxwait</th>
      <td><p>maximum waiting time in seconds to validate</p></td>
    </tr>
    <tr>
      <th>timeout</th>
      <td><p>'http' request timeout, default is 3, see details.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p><code>start_server</code> returns a list; <code>server_alive</code> returns
whether the server can be connected; others return nothing.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>The function <code>ensure_server</code> is a combination of
<code>start_server</code> and <code>server_alive</code>: it checks whether the target
server is alive first before starting the server. If <code>validate</code> is true,
then the it also wait until the server is completely up and ready to serve.</p>
<p><code>timeout</code> is the seconds that a request should wait to check if the
server is alive. On most UNIX systems, request fail immediately once the
server is not available. However on Windows, requests might block the session
if the server is unavailable. <code>timeout</code> is the upper time limit that
would take to fail the test. If the server fails to respond before the limit,
the test will also fail.</p>
<p><code>kill_server</code> stops the server as soon as possible. It sends signals to
the server to cancel the unfinished tasks and shutdown.
<code>autoclose_server</code> stops the server when the current R session exits.</p>
    <h2 class="hasAnchor" id="server-configuration"><a class="anchor" href="#server-configuration"></a>Server Configuration</h2>

    


<p>A server configuration is a file that contains key-value pairs. They are
used to tune your running servers on performance, security, and even
customize some actions.</p>
<p>A sample configuration file can be obtained via <code><a href='conf_sample.html'>conf_sample</a></code></p>
<p>Some values are characters. These characters will be parsed through
<code><a href='https://glue.tidyverse.org/reference/glue.html'>glue</a></code> function that evaluates dynamically. The adds
more flexibility to your settings.
For example, the default <code>startup_script</code> evaluates
<code><a href='https://rdrr.io/r/base/system.file.html'>system.file("scheduler/startup.R", package = "restbatch")</a></code> dynamically,
and pass the results as your actual startup script.</p>
<dl>
<dt>startup_script</dt><dd><p>path to the R script to run when starting up. For example,
setting up pools, load extra settings etc.</p></dd>
<dt>batch_cluster</dt><dd><p>path to the R script defining cluster functions.
See <code><a href='https://rdrr.io/pkg/batchtools/man/makeClusterFunctions.html'>makeClusterFunctions</a></code> on how to set up
computational nodes.</p></dd>
<dt>task,validate</dt><dd><p>R <code>plumber</code> files to handle new job and
validation requests</p></dd>
<dt>debug</dt><dd><p>yes or no to enable debug mode</p></dd>
<dt>require_auth</dt><dd><p>whether default authentication is on. The default
authentication uses 'openssl' that sends tokens in the request headers.</p></dd>
<dt>anonymous_request</dt><dd><p>whether to allow default tokens; works for a quick
set up scenarios like debugging, running on local machines, but will
introduce security issues is deployed on public addresses.</p></dd>
<dt>modules_require_auth</dt><dd><p>which modules require default authentications;
use comma to separate.</p></dd>
<dt>request_timeout</dt><dd><p>part of authentication system. When default
authentications is on, each request header needs to include a timestamp
and an encrypted token of that timestamp. The server will block the requests
that are too old to avoid someone accidentally "steals" your previous tokens.
The <code>request_timeout</code> defines the maximum time in seconds between
the encrypted request time and the actual time when server handles requests</p></dd>
<dt>max_concurrent_tasks</dt><dd><p>maximum of running tasks allowed</p></dd>
<dt>max_concurrent_jobs</dt><dd><p>maximum of running jobs for each task</p></dd>
<dt>max_release_tasks_per_second</dt><dd><p>A loop will be created in the server to
regularly check the task status (see <code>task_queue_interval</code>). The loop
blocks the session. If there are multiple tasks finished, releasing them
all might be time consuming, <code>max_release_tasks_per_second</code> controls
the maximum number of tasks to be released each
<code>task_queue_interval</code> seconds</p></dd>
<dt>task_queue_interval</dt><dd><p>intervals in seconds to check and update task
status queued or running on the server</p></dd>
<dt>task_root</dt><dd><p>where to store the task files</p></dd>
<dt>max_nodetime</dt><dd><p>sometimes a task might run forever or get lost. It
will still be in the running status. Set this number to indicate the max
time in seconds a job should execute; default is 10 days.</p></dd>
<dt>func_newjob</dt><dd><p>function to handle new tasks</p></dd>
<dt>func_validate_server</dt><dd><p>function to validate the server</p></dd>

</dl>

    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='conf_sample.html'>conf_sample</a></code>,
<code><a href='https://rdrr.io/pkg/batchtools/man/makeClusterFunctions.html'>makeClusterFunctions</a></code>, <code><a href='https://glue.tidyverse.org/reference/glue.html'>glue</a></code>.</p></div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'>
<span class='kw'>if</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/interactive.html'>interactive</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span><span class='op'>{</span>

<span class='co'># -------------------- Start a server tasks -----------------------</span>

<span class='co'># set default host, port to play with</span>
<span class='fu'><a href='default_url.html'>default_host</a></span><span class='op'>(</span><span class='st'>"127.0.0.1"</span><span class='op'>)</span>
<span class='fu'><a href='default_url.html'>default_port</a></span><span class='op'>(</span><span class='fl'>7033</span><span class='op'>)</span>

<span class='co'># start a server</span>
<span class='fu'>start_server</span><span class='op'>(</span><span class='op'>)</span>

<span class='fu'>server_alive</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># alternatively, you can just call</span>
<span class='fu'>ensure_server</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># -------------------- Run tasks -----------------------------------</span>

<span class='va'>task</span> <span class='op'>&lt;-</span> <span class='fu'><a href='restbench-tasks.html'>new_task2</a></span><span class='op'>(</span><span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span><span class='op'>{</span>
  <span class='kw'>if</span><span class='op'>(</span><span class='va'>x</span> <span class='op'>==</span> <span class='fl'>2</span><span class='op'>)</span><span class='op'>{</span>
    <span class='kw'><a href='https://rdrr.io/r/base/stop.html'>stop</a></span><span class='op'>(</span><span class='st'>"I stop no because."</span><span class='op'>)</span>
  <span class='op'>}</span>
  <span class='fu'><a href='https://rdrr.io/r/base/Sys.sleep.html'>Sys.sleep</a></span><span class='op'>(</span><span class='fl'>5</span><span class='op'>)</span>
  <span class='fu'><a href='https://rdrr.io/r/base/Sys.getpid.html'>Sys.getpid</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='op'>}</span>, x <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='fl'>3</span><span class='op'>)</span>

<span class='co'># Submit and run batch jobs</span>
<span class='va'>task</span><span class='op'>$</span><span class='fu'>submit</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># Check</span>
<span class='va'>task</span><span class='op'>$</span><span class='fu'>server_status</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># print task</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>task</span><span class='op'>)</span>

<span class='co'># obtain results</span>
<span class='va'>task</span><span class='op'>$</span><span class='fu'>collect</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># get result details</span>
<span class='fu'><a href='https://rdrr.io/r/base/attributes.html'>attributes</a></span><span class='op'>(</span><span class='va'>task</span><span class='op'>$</span><span class='fu'>collect</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># -------------------- An interactive shiny client -----------------</span>

<span class='kw'><a href='https://rdrr.io/r/base/source.html'>source</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/system.file.html'>system.file</a></span><span class='op'>(</span><span class='st'>'dashboards/client/app.R'</span>, package <span class='op'>=</span> <span class='st'>'restbatch'</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># -------------------- Stop the server ------------------------------</span>
<span class='fu'>kill_server</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># clean up</span>
<span class='va'>task</span><span class='op'>$</span><span class='fu'>remove</span><span class='op'>(</span><span class='op'>)</span>

<span class='op'>}</span>

</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Zhengjia Wang.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


